# タイミング調整ガイド

## 🎯 振動のタイミングを正確にする方法

### 問題
- 戦闘機に乗っている間、弱い振動が出続けてほしい
- 何もないときは振動を止めたい
- 衝突・爆発の瞬間を正確に検出したい

---

## ✅ 実装済みの対策

### 1. **AIプロンプトの改善**

以下を必ず記載するよう指示：
```
✓ 「戦闘機に乗っている」or「降りている」
✓ 「移動中」or「静止している」
✓ 「衝突する瞬間」「爆発の瞬間」を明確に
```

### 2. **ルールの精密化**

```python
# 強い衝撃（瞬間を正確に）
["衝突する瞬間", "衝突の瞬間", "爆発の瞬間"]
→ vibration:strong

# 弱い振動（乗り物搭乗中）
["戦闘機に乗っている", "車に乗っている"]
→ vibration:long

# 振動を止める
["静止", "降りている", "何もしていない"]
→ 振動なし
```

### 3. **最小継続時間**

```python
vibration:long = 1.0秒以上   # 乗り物の振動
vibration:strong = 1.0秒     # 衝撃
vibration:heartbeat = 2.5秒  # ドキドキ
```

### 4. **タイミングオフセット**

```python
TIMING_OFFSET = 0.5秒  # 信号を0.5秒遅らせる
```

---

## 🔧 さらに精度を上げる方法

### 方法1: サンプリング間隔を短くする（推奨）

`analyze_video.py` の41行目を編集：

```python
SAMPLE_INTERVAL = 0.25  # 0.5秒 → 0.25秒に変更
```

**効果：**
- ✅ 衝突・爆発の瞬間を逃しにくくなる
- ✅ より細かいタイミング制御
- ⚠️ API呼び出しが2倍になる（コスト増）
- ⚠️ 処理時間が2倍になる

**推奨設定：**
```python
# 短い動画（30秒以下）：精密解析
SAMPLE_INTERVAL = 0.25

# 長い動画（1分以上）：バランス型
SAMPLE_INTERVAL = 0.5

# 非常に長い動画（5分以上）：高速処理
SAMPLE_INTERVAL = 1.0
```

---

### 方法2: プロンプトにフレーム間の変化を指示

現在のプロンプトに追加：

```python
"【フレーム間の変化】\n"
"前のフレームと比較して、以下が変化した場合は必ず明記：\n"
"- 衝突が「発生した」（衝突前 → 衝突の瞬間）\n"
"- 爆発が「発生した」（爆発前 → 爆発の瞬間）\n"
"- 乗り物に「乗った」or「降りた」\n"
"- 動きが「開始した」or「停止した」\n"
```

---

### 方法3: キーワードの追加

`RULES` に以下を追加：

```python
# 爆発の瞬間をさらに詳細に
(["爆破", "炸裂", "破裂", "burst", "detonate", "blown up"],
 [("vibration","strong"), ("flash","burst")]),

# 衝突の瞬間をさらに詳細に  
(["激突した", "衝突した", "ぶつかった", "crashed", "collided", "hit"],
 [("vibration","strong")]),

# 戦闘機・飛行機を確実に
(["コックピット", "操縦", "飛行", "cockpit", "flying", "aircraft"],
 [("vibration","long")]),
```

---

## 📊 推奨設定（動画の種類別）

### アクション映画・戦闘シーン
```python
SAMPLE_INTERVAL = 0.25  # 細かく
BATCH_SIZE = 20         # バッチは大きめ
```

### ドライブシーン・移動シーン
```python
SAMPLE_INTERVAL = 0.5   # 標準
BATCH_SIZE = 15         # 標準
```

### 静かなシーン多め
```python
SAMPLE_INTERVAL = 1.0   # 粗めでOK
BATCH_SIZE = 10         # 小さめ
```

---

## 🎬 テストと調整の流れ

### Step 1: まず標準設定で解析
```python
SAMPLE_INTERVAL = 0.5
```

### Step 2: 再生して確認
```bash
python playback_video.py "your_video.mp4"
```

### Step 3: 問題があれば調整

**衝突の瞬間を逃している場合：**
→ `SAMPLE_INTERVAL = 0.25` に変更して再解析

**弱い振動が出ない場合：**
→ AIのキャプションを確認
→ 「乗っている」という表現がない場合、プロンプトを強化

**タイミングがずれている場合：**
→ `TIMING_OFFSET` を調整（0.3 ~ 0.7秒で試す）

---

## 💡 デバッグ方法

### JSONファイルを確認

```json
{
  "t": 10.5,
  "action": "caption",
  "text": "戦闘機に乗っており、空中を飛行中"  ← これがあれば振動が出るはず
}
```

このキャプションに「乗っている」「飛行中」があれば、`vibration:long` が発動するはず。

**もし発動していない場合：**
1. キャプションにキーワードが含まれているか確認
2. ルールのキーワードリストに追加
3. 再解析

---

## 🚀 現在の最適な設定

```python
# analyze_video.py
SAMPLE_INTERVAL = 0.5   # ⭐ アクション多い場合は0.25に
BATCH_SIZE = 15
MIN_DURATION["vibration:long"] = 1.0秒
MIN_DURATION["vibration:strong"] = 1.0秒
MIN_DURATION["vibration:heartbeat"] = 2.5秒

# playback_video.py
TIMING_OFFSET = 0.5秒   # ⭐ 必要に応じて0.3～0.7で調整
```

---

**より正確な検出が必要な場合は、`SAMPLE_INTERVAL = 0.25` に変更して再解析してください！**

