# デバッグコントローラー - 拡張機能ガイド

最終更新: 2025年11月8日

---

## 🎯 概要

デバッグコントローラーに以下の拡張機能が追加されました:

1. **タブ式UI** - 機能ごとに整理された使いやすいインターフェース
2. **自動テストモード** - デバイスを順番に自動テスト
3. **クイックプリセット** - よく使うパターンをワンタッチ実行
4. **デバイス詳細ステータス** - 各ESPの接続状態を詳細表示
5. **通信ログビューワー** - リアルタイムでMQTT通信を確認

---

## 📱 タブ式インターフェース

### タブ1: 手動制御

従来の機能（ESP1-4の個別制御）が集約されています。

**特徴**:
- 全アクチュエータの個別操作
- 直感的なボタンレイアウト
- 色分けされた視覚的フィードバック

### タブ2: 自動テスト

デバイスを自動的にテストする機能です。

#### クイックテスト（30秒）

**実行内容**:
1. Water単発トリガー
2. Wind ON → OFF
3. LED点灯 → 点滅 → OFF
4. RGB LED（赤 → 青 → 緑）
5. Motor1 強 → OFF
6. Motor2 強 → OFF
7. 全停止

**使用タイミング**:
- セットアップ後の動作確認
- 簡易的な動作チェック
- デモンストレーション前の確認

#### 完全テスト（2分）

**実行内容**:
- 全アクチュエータの全パターンをテスト
- LED点滅パターン（Slow/Fast）
- RGB全6色
- Motor振動パターン（強/中強/中弱/弱/心拍/Rumble）

**使用タイミング**:
- 新規セットアップ時
- デバイス交換後の確認
- 本番前の完全チェック

#### プログレスバー表示

テスト実行中は以下が表示されます:
- 現在のステップ名
- 進行状況（N/総ステップ数）
- プログレスバー（視覚的な進捗表示）

### タブ3: デバイス状態

接続されているESPデバイスの詳細情報を表示します。

**表示情報**:
- デバイスID
- デバイスタイプ（water_wind, led, motor1, motor2）
- オンライン/オフライン状態（🟢/🔴）
- 最終ハートビート時刻

**使用例**:
```
┌─────────────────────────────────┐
│ alive_esp1_water      🟢 オンライン │
│ タイプ: water_wind | 最終応答: 2025-11-08 15:30:45 │
├─────────────────────────────────┤
│ alive_esp2_led        🟢 オンライン │
│ タイプ: led | 最終応答: 2025-11-08 15:30:46 │
└─────────────────────────────────┘
```

**自動更新**:
- タブを開くたびに最新情報を取得
- リアルタイムでデバイスの状態変化を確認可能

### タブ4: ログ

MQTT通信の履歴をリアルタイムで表示します。

**表示内容**:
- タイムスタンプ
- 送信コマンド（topic + payload）
- 成功/失敗ステータス

**ログ例**:
```
[15:30:45] 📤 送信: /4dx/water = trigger
[15:30:45] ✅ 成功: /4dx/water
[15:30:47] 📤 送信: /4dx/wind = ON
[15:30:47] ✅ 成功: /4dx/wind
```

**色分け**:
- ⚪ 通常ログ: 白色
- ✅ 成功: 緑色
- ❌ エラー: 赤色
- タイムスタンプ: グレー

**特徴**:
- 最新20件を保持
- 自動スクロール
- 手動更新ボタン

---

## 🎯 クイックプリセット

よく使うエフェクトパターンをワンタッチで実行できます。

### アクションシーン

**エフェクト**:
- Motor1/2: 強振動
- Wind: ON
- Light: 高速点滅（3秒間）
- 自動停止

**使用シーン**:
- 爆発シーン
- 戦闘シーン
- 激しいアクション

### ホラーシーン

**エフェクト**:
- RGB: 赤色
- Light: ゆっくり点滅
- Motor1/2: ハートビートパターン（心拍）

**使用シーン**:
- ホラー映画
- サスペンスシーン
- 緊張感のある場面

### レーシング

**エフェクト**:
- Motor1/2: 高速Rumbleパターン
- Wind: ON
- RGB: シアン色

**使用シーン**:
- カーレース
- スピード感のある場面
- 疾走シーン

### デモ演出

**エフェクト**:
- RGB: 赤→緑→青（順次変化）
- Light: 高速点滅
- Wind: ON
- Motor1: 強振動
- Water: 単発トリガー
- 自動停止

**使用シーン**:
- システムデモンストレーション
- 全機能紹介
- 初回体験

---

## 🔧 技術仕様

### 新規追加エンドポイント

#### GET /api/debug/logs

**説明**: 最新のMQTT通信ログを取得

**レスポンス**:
```json
{
  "logs": [
    {
      "timestamp": "2025-11-08T15:30:45.123456",
      "type": "sent",
      "topic": "/4dx/water",
      "payload": "trigger"
    }
  ]
}
```

#### GET /api/debug/system-info

**説明**: システム情報を取得

**レスポンス**:
```json
{
  "platform": "Linux",
  "python_version": "3.9.2",
  "cpu_percent": 15.2,
  "memory": {
    "total_gb": 1.0,
    "used_gb": 0.4,
    "percent": 40.0
  },
  "config": {
    "device_hub_id": "DH001",
    "mqtt_broker": "localhost:1883",
    "sync_tolerance_ms": 100
  }
}
```

#### POST /api/debug/mqtt-test

**説明**: MQTT接続をテスト

**レスポンス**:
```json
{
  "success": true,
  "connected": true,
  "test_sent": true,
  "topic": "/4dx/debug/test",
  "payload": "test_1699437045.123"
}
```

### フロントエンドAPI

#### タブ切り替え

```javascript
switchTab(tabName)
```

**引数**:
- `tabName`: 'controls' | 'auto-test' | 'devices' | 'logs'

#### 自動テスト実行

```javascript
runAutoTest(mode)
```

**引数**:
- `mode`: 'quick' (30秒) | 'full' (2分)

#### プリセット実行

```javascript
runPreset(presetName)
```

**引数**:
- `presetName`: 'action' | 'horror' | 'racing' | 'demo'

#### ログ追加

```javascript
addLog(message, type)
```

**引数**:
- `message`: ログメッセージ
- `type`: 'info' | 'success' | 'error'

---

## 📊 使用例

### シナリオ1: 新規セットアップ後の確認

```
1. デバッグコントローラーにアクセス
2. 「デバイス状態」タブで全デバイスがオンラインか確認
3. 「自動テスト」タブで「クイックテスト」を実行
4. 「ログ」タブでエラーがないか確認
5. 問題があれば個別デバイスを「手動制御」で確認
```

### シナリオ2: デモンストレーション前の準備

```
1. 「自動テスト」タブで「完全テスト」を実行（2分）
2. 全デバイスが正常動作することを確認
3. 「デモ演出」プリセットでリハーサル
4. 観客に見せる前に「ALL STOP」で待機状態に
```

### シナリオ3: トラブルシューティング

```
1. 「デバイス状態」タブでオフラインデバイスを特定
2. 「ログ」タブで通信エラーを確認
3. 「手動制御」タブで該当デバイスを個別テスト
4. 必要に応じてESPデバイスを再起動
```

---

## 🎨 UI/UXの改善点

### Before（旧バージョン）

- 全コントロールが縦に並んでスクロールが長い
- テスト機能なし
- ログ確認にサーバーアクセスが必要

### After（現バージョン）

✅ **タブ式UI** - 機能ごとに整理
✅ **自動テスト** - ワンクリックで全確認
✅ **プリセット** - よく使うパターンを保存
✅ **リアルタイムログ** - ブラウザ上で確認
✅ **デバイス詳細** - 一目で状態把握

---

## 🔒 セキュリティ考慮事項

### 現在の実装

- 認証なし（ローカルネットワークのみ想定）
- ログは最新20件のみ（メモリ節約）
- 自動テストは重複実行防止機能あり

### 本番環境での推奨対策

1. **IPアドレス制限**
   ```python
   from flask import request
   
   ALLOWED_IPS = ['192.168.1.100', '192.168.1.101']
   
   @app.before_request
   def limit_remote_addr():
       if request.remote_addr not in ALLOWED_IPS:
           abort(403)
   ```

2. **Basic認証**
   ```python
   from flask_httpauth import HTTPBasicAuth
   
   auth = HTTPBasicAuth()
   
   @auth.verify_password
   def verify_password(username, password):
       return username == 'admin' and password == 'secret'
   
   @app.route('/')
   @auth.login_required
   def index():
       return render_template('controller.html')
   ```

3. **HTTPS対応**
   - 自己署名証明書の使用
   - Let's Encrypt証明書の取得

---

## 🚀 今後の拡張案

### 短期（実装済み）

- [x] タブ式UI
- [x] 自動テストモード
- [x] クイックプリセット
- [x] デバイス詳細ステータス
- [x] 通信ログビューワー

### 中期（検討中）

- [ ] カスタムプリセット作成機能
- [ ] テスト結果のレポート出力
- [ ] システムメトリクスのグラフ表示
- [ ] デバイスごとの統計情報
- [ ] タイムライン再生コントロール

### 長期（将来）

- [ ] WebSocketによるリアルタイム更新
- [ ] 複数デバイスハブの統合管理
- [ ] AIによる異常検知
- [ ] クラウド連携機能

---

## 📞 トラブルシューティング

### 自動テストが途中で止まる

**原因**: MQTTブローカーとの接続が不安定

**解決策**:
```bash
sudo systemctl restart mosquitto
```

### ログが表示されない

**原因**: 通信ログファイルが存在しない

**解決策**:
```bash
# ログディレクトリを作成
mkdir -p ~/4dx-home/data/communication_logs

# ログ機能を有効化（.envファイル）
ENABLE_COMMUNICATION_LOG=True
```

### デバイス詳細が「読み込み中...」のまま

**原因**: `/api/devices`エンドポイントのエラー

**解決策**:
1. ブラウザの開発者ツール（F12）でコンソールエラーを確認
2. サーバーログを確認: `tail -f data/rpi_server.log`
3. サーバーを再起動

---

## 📚 関連ドキュメント

- [DEBUG_CONTROLLER.md](./DEBUG_CONTROLLER.md) - 基本的な使い方
- [IMPLEMENTATION_STATUS.md](./IMPLEMENTATION_STATUS.md) - 実装状況
- [README.md](./README.md) - プロジェクト概要
- [QUICK_START.md](./QUICK_START.md) - クイックスタート

---

**バージョン**: 2.0.0  
**追加機能**: タブUI、自動テスト、プリセット、詳細ステータス、ログビューワー  
**最終更新**: 2025年11月8日
