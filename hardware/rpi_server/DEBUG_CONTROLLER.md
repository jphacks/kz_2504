# 4DX@HOME デバッグコントローラー

## 概要

このドキュメントでは、Raspberry Pi サーバーに組み込まれたデバッグコントローラーの使い方を説明します。

デバッグコントローラーは、ラズベリーパイと同じWiFiネットワーク上にあるデバイス（スマートフォン、タブレット、PCなど）から、簡単にアクチュエータを操作できるWebベースのUIです。

## アクセス方法

### 1. ラズパイサーバーを起動

```bash
cd hardware/rpi_server
python main.py your_session_id
```

### 2. ラズパイのIPアドレスを確認

ラズパイ上で以下のコマンドを実行:

```bash
hostname -I
```

出力例: `192.168.1.100`

### 3. スマホまたはPCのブラウザでアクセス

同じWiFiネットワークに接続したデバイスのブラウザから以下のURLにアクセス:

```
http://192.168.1.100:8000/
```

> **注意**: `192.168.1.100` の部分は、手順2で確認した実際のIPアドレスに置き換えてください。

> **ポート番号**: デフォルトは `8000` です。`.env` ファイルの `FLASK_PORT` で変更可能です。

## デバッグコントローラーの機能

### 🛑 緊急停止 (ALL STOP)

画面上部にある**赤い大きなボタン**をタップすることで、全アクチュエータを即座に停止できます。

**停止されるデバイス**:
- 風（Wind）
- 照明（Light）
- モーター1・2（Vibration）
- RGB LED は赤色に戻る

**使用シーン**:
- 異常動作時の緊急停止
- テスト中の動作を止めたい時
- 次のテストに移る前のリセット

### デバイス操作ボタン

#### ESP 1 (Water/Wind)

**Water (Servo)**
- `Water (単発)`: ウォーターサーボを1回作動
- `Water Loop ON`: 連続動作開始
- `Water Loop OFF`: 連続動作停止

**Wind (Motor)**
- `Wind ON`: 風モーター起動
- `Wind OFF`: 風モーター停止

#### ESP 2 (LEDs)

**Single LED (D2)**
- `ON`: LED点灯
- `Blink Slow`: ゆっくり点滅
- `Blink Fast`: 速く点滅
- `OFF`: LED消灯

**RGB Tape (D5,D6,D7)**
- `Red`, `Green`, `Blue`, `Yellow`, `Cyan`, `Purple`: 各色に変更

#### ESP 3 / ESP 4 (Motor 1 / Motor 2)

**Vibration Patterns**
- `振動 強`: 最大強度
- `振動 中強`: 中程度の強さ
- `振動 中弱`: 弱めの強さ
- `振動 弱`: 最小強度
- `心拍`: ハートビートパターン
- `Rumble Fast`: 高速振動
- `Rumble Slow`: 低速振動
- `OFF`: 停止

### ステータス表示

画面上部には以下の情報がリアルタイムで表示されます:

- **接続状態**: サーバーとの接続状況
- **デバイス情報**: オンライン中のESPデバイス数
- **MQTT状態**: MQTTブローカーとの接続状況

## 技術仕様

### エンドポイント

デバッグコントローラーは以下のFlask HTTPエンドポイントを使用します:

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/` | GET | コントローラーUIを表示 |
| `/health` | GET | ヘルスチェック |
| `/api/status` | GET | デバイスハブのステータス |
| `/api/devices` | GET | 接続中のデバイス一覧 |
| `/api/mqtt/publish` | POST | MQTTメッセージを送信 |

### MQTT通信

コントローラーから送信されるMQTTコマンド例:

```json
{
  "topic": "/4dx/motor1/control",
  "payload": "STRONG"
}
```

### 緊急停止のMQTTコマンド

`ALL STOP` ボタンを押すと、以下の5つのコマンドが並列送信されます:

```javascript
[
  { topic: '/4dx/wind', payload: 'OFF' },
  { topic: '/4dx/light', payload: 'OFF' },
  { topic: '/4dx/color', payload: 'RED' },
  { topic: '/4dx/motor1/control', payload: 'OFF' },
  { topic: '/4dx/motor2/control', payload: 'OFF' }
]
```

## トラブルシューティング

### ページにアクセスできない

**原因1**: ラズパイとスマホが異なるWiFiネットワークに接続されている
- **解決策**: 両方を同じWiFiネットワークに接続してください

**原因2**: ファイアウォールがポート8000をブロックしている
- **解決策**: ラズパイのファイアウォール設定を確認してください

```bash
sudo ufw allow 8000
```

**原因3**: ラズパイサーバーが起動していない
- **解決策**: `python main.py` でサーバーを起動してください

### ボタンを押しても反応しない

**原因1**: MQTTブローカーが起動していない
- **解決策**: Mosquitto MQTTブローカーを起動してください

```bash
sudo systemctl start mosquitto
```

**原因2**: ESPデバイスがオフラインになっている
- **解決策**: デバイス情報を確認し、ESPデバイスを再起動してください

### ステータスが「接続失敗」になる

**原因**: Flaskサーバーが正常に起動していない
- **解決策**: ログを確認してエラーを特定してください

```bash
tail -f data/rpi_server.log
```

## セキュリティに関する注意

⚠️ **このコントローラーは開発・デバッグ用途のみを想定しています**

- 認証機能は実装されていません
- 同じWiFiネットワーク上の誰でもアクセスできます
- 本番環境での使用は推奨されません

本番環境で使用する場合は、以下の対策を実装してください:
- HTTPSの有効化
- Basic認証またはトークンベース認証の実装
- IPアドレスベースのアクセス制限

## 関連ドキュメント

- [QUICK_START.md](./QUICK_START.md) - ラズパイサーバーの起動方法
- [README.md](./README.md) - プロジェクト全体の概要
- [IMPLEMENTATION_PLAN.md](./IMPLEMENTATION_PLAN.md) - 実装詳細
- [TIME_TOLERANCE_SPEC.md](./TIME_TOLERANCE_SPEC.md) - タイムライン同期仕様

## まとめ

デバッグコントローラーは、開発・テスト時にアクチュエータを手動で操作するための便利なツールです。

スマホから簡単にアクセスでき、直感的なUIで全てのエフェクトを確認できます。

**重要な機能**:
- ✅ スマホ・タブレット対応のレスポンシブデザイン
- ✅ リアルタイムなステータス表示
- ✅ 緊急停止機能（ALL STOP）
- ✅ 全アクチュエータの個別制御

開発作業を効率化し、安全にデバイステストを行うためにご活用ください。
