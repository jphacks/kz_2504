# ğŸš€ 4DX@HOME Cloud Run Production Dockerfile
FROM python:3.12-slim

# Cloud Runæœ€é©åŒ–è¨­å®š
LABEL cloud.google.com/logs-redirect="true"

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ï¼ˆæœ€å°é™ï¼‰
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Pythonä¾å­˜é–¢ä¿‚
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
COPY app/ ./app/
COPY data/ ./data/

# Cloud Runç’°å¢ƒå¤‰æ•°
ENV PYTHONPATH=/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PORT=8080
ENV HOST=0.0.0.0

# Cloud Runç”¨ãƒãƒ¼ãƒˆ
EXPOSE 8080

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆCloud Runç”¨ï¼‰ã€‚$PORT ã‚’ä½¿ã†ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=2 \
    CMD curl -f http://localhost:$PORT/api/version || exit 1

# Entrypoint: JSON é…åˆ—ã§ sh -c ã‚’ä½¿ã„ã€ç’°å¢ƒå¤‰æ•°ã‚’å±•é–‹ã—ã¦ exec ã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç½®æ›ã—ã¾ã™ã€‚
# ã“ã‚Œã«ã‚ˆã‚Šã‚·ã‚°ãƒŠãƒ«ãŒæ­£ã—ãä¼æ¬ã—ã€ç’°å¢ƒå¤‰æ•° ($PORT / $HOST) ã‚’å‹•çš„ã«ä½¿ãˆã¾ã™ã€‚
ENTRYPOINT ["sh", "-c", "exec uvicorn app.main:app --host ${HOST} --port ${PORT} --workers 1 --log-level info --access-log --no-use-colors"]